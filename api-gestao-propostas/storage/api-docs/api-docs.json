{
    "openapi": "3.0.0",
    "info": {
        "title": "API Gestão de Propostas",
        "description": "API REST para gestão de clientes e propostas. Suporta idempotência via header Idempotency-Key e optimistic lock em atualizações.",
        "version": "1.0.0"
    },
    "servers": [
        {
            "url": "http://localhost:8000/api/v1",
            "description": "Local"
        },
        {
            "url": "/api/v1",
            "description": "Relativo"
        }
    ],
    "paths": {
        "/clientes": {
            "post": {
                "tags": [
                    "Clientes"
                ],
                "summary": "Criar cliente",
                "operationId": "9dcdac6fa3278f147b4d6690c773aae3",
                "parameters": [
                    {
                        "name": "Idempotency-Key",
                        "in": "header",
                        "description": "Chave para garantir idempotência (evita duplicatas)",
                        "required": false,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "nome",
                                    "email",
                                    "documento"
                                ],
                                "properties": {
                                    "nome": {
                                        "type": "string",
                                        "example": "João Silva"
                                    },
                                    "email": {
                                        "type": "string",
                                        "format": "email",
                                        "example": "joao@example.com"
                                    },
                                    "documento": {
                                        "description": "CPF (11 dígitos) ou CNPJ (14 dígitos)",
                                        "type": "string",
                                        "example": "12345678901"
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Cliente criado com sucesso",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Cliente"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Erro de validação",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/clientes/{cliente}": {
            "get": {
                "tags": [
                    "Clientes"
                ],
                "summary": "Obter cliente por ID",
                "operationId": "01b61e47aa69d98eccb71ecc5a103ec9",
                "parameters": [
                    {
                        "name": "cliente",
                        "in": "path",
                        "description": "ID do cliente",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Cliente encontrado",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Cliente"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Cliente não encontrado",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas": {
            "get": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Listar propostas",
                "description": "Lista propostas com filtros, ordenação e paginação",
                "operationId": "2a0f96c5924c255560681a447cdb80b3",
                "parameters": [
                    {
                        "name": "status",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "DRAFT",
                                "SUBMITTED",
                                "APPROVED",
                                "REJECTED",
                                "CANCELED"
                            ],
                            "example": "DRAFT"
                        }
                    },
                    {
                        "name": "cliente_id",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "example": 1
                        }
                    },
                    {
                        "name": "produto",
                        "in": "query",
                        "description": "Busca parcial (ILIKE)",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "example": "Seguro"
                        }
                    },
                    {
                        "name": "valor_min",
                        "in": "query",
                        "description": "Valor mensal mínimo",
                        "required": false,
                        "schema": {
                            "type": "number",
                            "example": 100
                        }
                    },
                    {
                        "name": "valor_max",
                        "in": "query",
                        "description": "Valor mensal máximo",
                        "required": false,
                        "schema": {
                            "type": "number",
                            "example": 500
                        }
                    },
                    {
                        "name": "ordenar_por",
                        "in": "query",
                        "description": "Campo para ordenação",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "created_at",
                                "valor_mensal",
                                "produto",
                                "status"
                            ],
                            "example": "created_at"
                        }
                    },
                    {
                        "name": "direcao",
                        "in": "query",
                        "description": "Direção da ordenação",
                        "required": false,
                        "schema": {
                            "type": "string",
                            "enum": [
                                "asc",
                                "desc"
                            ],
                            "example": "desc"
                        }
                    },
                    {
                        "name": "per_page",
                        "in": "query",
                        "description": "Itens por página (máx. 100, default 15)",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "example": 15
                        }
                    },
                    {
                        "name": "page",
                        "in": "query",
                        "required": false,
                        "schema": {
                            "type": "integer",
                            "example": 1
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Lista paginada de propostas"
                    }
                }
            },
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Criar proposta",
                "operationId": "c89c6b9895eb084a1ec21a264be20669",
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "cliente_id",
                                    "produto",
                                    "valor_mensal"
                                ],
                                "properties": {
                                    "cliente_id": {
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "produto": {
                                        "type": "string",
                                        "example": "Seguro Auto"
                                    },
                                    "valor_mensal": {
                                        "type": "number",
                                        "example": 150
                                    },
                                    "origem": {
                                        "description": "Opcional, default: API",
                                        "type": "string",
                                        "enum": [
                                            "APP",
                                            "SITE",
                                            "API"
                                        ]
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "201": {
                        "description": "Proposta criada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Erro de validação ou regra de negócio",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas/{proposta}": {
            "get": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Obter proposta por ID",
                "operationId": "7b3c3a10d792350035c57064f663682e",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "description": "ID da proposta",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta encontrada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Proposta não encontrada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "delete": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Excluir proposta (soft delete)",
                "description": "Exclusão lógica: marca deleted_at e registra evento DELETED_LOGICAL na auditoria. GET na proposta excluída retorna 404.",
                "operationId": "c8225a5b6b961f83dfb1225eb3df2e8e",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "204": {
                        "description": "Proposta excluída com sucesso"
                    },
                    "404": {
                        "description": "Proposta não encontrada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            },
            "patch": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Atualizar proposta",
                "description": "Atualiza campos da proposta em DRAFT. Requer versão para optimistic lock. Retorna 409 se versão desatualizada.",
                "operationId": "f56d5024340d7d19bd85cc094d2b98e7",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "required": [
                                    "versao"
                                ],
                                "properties": {
                                    "versao": {
                                        "description": "Versão atual para optimistic lock",
                                        "type": "integer",
                                        "example": 1
                                    },
                                    "produto": {
                                        "type": "string",
                                        "example": "Seguro Residencial"
                                    },
                                    "valor_mensal": {
                                        "type": "number",
                                        "example": 199.9
                                    }
                                },
                                "type": "object"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "Proposta atualizada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "409": {
                        "description": "Conflito de versão",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Apenas propostas em DRAFT podem ser editadas",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas/{proposta}/submit": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Submeter proposta",
                "description": "Transiciona DRAFT → SUBMITTED. Aceita Idempotency-Key para evitar duplicatas em retries.",
                "operationId": "a9eb9d508f96c4534357576f5208d6cb",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    },
                    {
                        "name": "Idempotency-Key",
                        "in": "header",
                        "required": false,
                        "schema": {
                            "type": "string"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta submetida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida ou proposta não está em DRAFT",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas/{proposta}/approve": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Aprovar proposta",
                "description": "Transiciona SUBMITTED → APPROVED",
                "operationId": "b909cdeaec6ccff41d240855d0780027",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta aprovada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas/{proposta}/reject": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Rejeitar proposta",
                "description": "Transiciona SUBMITTED → REJECTED",
                "operationId": "c95058f26ae226e48c79df763bab678f",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta rejeitada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas/{proposta}/cancel": {
            "post": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Cancelar proposta",
                "description": "Transiciona SUBMITTED → CANCELED",
                "operationId": "ae9342932a814dcaaaf17b4a3baa0d8e",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Proposta cancelada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Proposta"
                                }
                            }
                        }
                    },
                    "422": {
                        "description": "Transição inválida",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        },
        "/propostas/{proposta}/auditoria": {
            "get": {
                "tags": [
                    "Propostas"
                ],
                "summary": "Histórico de auditoria",
                "description": "Retorna o histórico de alterações da proposta",
                "operationId": "844eabf98001d91e73d9910544e3c872",
                "parameters": [
                    {
                        "name": "proposta",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "integer"
                        }
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Lista de eventos de auditoria",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "$ref": "#/components/schemas/PropostaAuditoria"
                                    }
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Proposta não encontrada",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/Error"
                                }
                            }
                        }
                    }
                }
            }
        }
    },
    "components": {
        "schemas": {
            "Cliente": {
                "title": "Cliente",
                "properties": {
                    "id": {
                        "type": "integer",
                        "example": 1
                    },
                    "nome": {
                        "type": "string",
                        "example": "João Silva"
                    },
                    "email": {
                        "type": "string",
                        "format": "email",
                        "example": "joao@example.com"
                    },
                    "documento": {
                        "description": "CPF (11 dígitos) ou CNPJ (14 dígitos)",
                        "type": "string",
                        "example": "12345678901"
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "Proposta": {
                "title": "Proposta",
                "properties": {
                    "id": {
                        "type": "integer",
                        "example": 1
                    },
                    "cliente_id": {
                        "type": "integer",
                        "example": 1
                    },
                    "produto": {
                        "type": "string",
                        "example": "Seguro Auto"
                    },
                    "valor_mensal": {
                        "type": "number",
                        "format": "float",
                        "example": 150
                    },
                    "status": {
                        "type": "string",
                        "enum": [
                            "DRAFT",
                            "SUBMITTED",
                            "APPROVED",
                            "REJECTED",
                            "CANCELED"
                        ]
                    },
                    "origem": {
                        "type": "string",
                        "enum": [
                            "APP",
                            "SITE",
                            "API"
                        ]
                    },
                    "versao": {
                        "type": "integer",
                        "example": 1
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "updated_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "PropostaAuditoria": {
                "title": "PropostaAuditoria",
                "properties": {
                    "id": {
                        "type": "integer",
                        "example": 1
                    },
                    "proposta_id": {
                        "type": "integer",
                        "example": 1
                    },
                    "actor": {
                        "type": "string",
                        "example": "system"
                    },
                    "evento": {
                        "type": "string",
                        "enum": [
                            "CREATED",
                            "UPDATED_FIELDS",
                            "STATUS_CHANGED",
                            "DELETED_LOGICAL"
                        ]
                    },
                    "payload": {
                        "description": "Dados da alteração",
                        "type": "object"
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    }
                },
                "type": "object"
            },
            "Error": {
                "title": "Error",
                "properties": {
                    "message": {
                        "type": "string",
                        "example": "Mensagem de erro"
                    },
                    "errors": {
                        "description": "Detalhes de validação (quando aplicável)",
                        "type": "object"
                    }
                },
                "type": "object"
            }
        }
    },
    "tags": [
        {
            "name": "Clientes",
            "description": "Clientes"
        },
        {
            "name": "Propostas",
            "description": "Propostas"
        }
    ]
}